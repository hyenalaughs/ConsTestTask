1	SQL - БАЗОВЫЕ ЗНАНИЯ  


1.1	Вопрос на знание select … join  
Есть две таблицы:  
Т1 (ID int, Text1 …., text2 …. B и т.д.)  
И   
Т2 (ID int, Text1 …., text2 …. B и т.д.)  

Написать select
1.	Вывести все поля из обеих таблиц, вывести записи при условии, что ID обеих таблиц совпадают.
2.	Вывести все поля из обеих таблиц, вывести все записи из T1 и только имеющиеся в T2
3.	Вывести все записи из T1, при условии, что таких ID нет в T2


Ответ:  
1.   
```sql
SELECT
    t1.*,
    t2.*
FROM T1 AS t1
INNER JOIN T2 AS t2
    ON t1.ID = t2.ID;
```

2.  
```sql
SELECT
    t1.*,
    t2.*
FROM T1 AS t1
LEFT JOIN T2 AS t2
    ON t1.ID = t2.ID;
```

3.  
```sql
SELECT
    t1.*
FROM T1 AS t1
LEFT JOIN T2 AS t2
    ON t1.ID = t2.ID
WHERE t2.ID IS NULL;
```

1.2	Как вывести результат запроса в XML?  


Пусть есть таблица T со следующим видом и содержанием. Что вернет SQL запрос?  
Id	Code	Name	StatusId  
1	gargadgadfga	Запрос предложений 1	45  
2	bsftrggdfgadfgdfat	Запрос предложений 2	2  
3	gfadgdfsgdfsgs	Запрос предложений 3	45  
4	afgereaerffdgvdf	Запрос предложений 4	3  
5	dgadfterdsgsdgad	Запрос предложений 5	45  
6	argrgag	Запрос предложений 6	2  

Написать запрос, выводящий данные в XML  

Ответ:  
```sql
SELECT 
    Id,
    Code,
    Name,
    StatusId
FROM T
FOR XML AUTO;
```


1.3	Как выбрать данные из поля с XML?  
Написать запрос, выбирающий данные из XML из предыдущего вопроса  
Отфильтровать данные по StatusId != 3  

```sql
SELECT
    x.value('(Id/text())[1]', 'INT')       AS Id,
    x.value('(Code/text())[1]', 'NVARCHAR(100)') AS Code,
    x.value('(Name/text())[1]', 'NVARCHAR(100)') AS Name,
    x.value('(StatusId/text())[1]', 'INT') AS StatusId
FROM T_XML
CROSS APPLY XmlData.nodes('/rows/row') AS t(x)
WHERE x.value('(StatusId/text())[1]', 'INT') != 3;
```


1.4	Что такое hints

Ответ:  Хинт (hint) – это указание оптимизатору запросов, которое переопределяет его поведение по умолчанию на время выполнения SQL инструкции.  
Иными словами, с помощью хинта мы можем сказать оптимизатору запросов, как именно поступить в той или иной ситуации в процессе построения плана запроса.  
Например, мы можем сказать, какой конкретно индекс использовать, какой конкретно алгоритм физического соединения таблиц применить, или, допустим, на время выполнения запроса разрешить «грязное чтение».  


1.5 Какие виды блокировок существуют?  

Ответ:  
Разделяемые (Shared) блокировки:  
- Разрешают нескольким транзакциям одновременно читать одни и те же данные.
- Не допускают изменений данных другими транзакциями, пока разделяемая блокировка активна.
- Обычно используются для операций чтения (SELECT).

Исключающие (Exclusive) блокировки:
- Разрешают только одной транзакции доступ к данным.
- Блокируют любые другие транзакции, пытающиеся получить доступ к тем же данным (включая чтение и изменение).
- Обычно используются для операций записи (UPDATE, DELETE, INSERT).

  
Блокировки обновления (Update):
- Предварительная блокировка, используемая перед изменением данных.
- Позволяет транзакциям убедиться, что данные не будут изменены другими транзакциями до того, как они будут обновлены.
- Используются для предотвращения взаимоблокировок (deadlocks).

  
Намерения (Intent) блокировки:
- Обозначают намерение заблокировать ресурс на более низком уровне. 
- Устанавливаются перед тем, как транзакция устанавливает более строгую блокировку на более низком уровне. 
- Помогают избежать конфликтов при блокировке иерархических структур данных.


1.6	Что такое транзакция?  

Ответ: Транзакция - набор операций, который в случае неудачи на одном из этапов отменяется полностью и результат выполнений откатывается до внесения изменений этой транзакцией.  


1.7	Чем delete … от truncate … отличается?  

Ответ:  

DELETE:  
- Удаляет строки построчно.  
- Каждая удалённая строка логируется в журнал транзакций (логируется операция для каждой строки).  
- Может быть медленным для больших таблиц.

TRUNCATE:  
- Удаляет все строки сразу (сбрасывает страницы данных).
- Логируется только факт очистки страниц, а не удаление каждой строки.
- Работает значительно быстрее на больших таблицах.


2.1	НАПИШИТЕ ХРАНИМУЮ ПРОЦЕДУРУ  
Постановка задачи  
/*  
Есть база данных в банке. В базе данных есть таблица со счетами (назовем её для простоты T). В таблице T есть среди прочих поля:  
N - Номер счета  
S - сумма на счете  
Требуется:  
Написать хранимую процедуру на языке SQL, которая:   
1. Принимает в качестве аргументов параметры:  
	@N1 - номер первого счета  
	@N2 - номер второго счета  
	@S - сумма денежных средств  
2. Переводит сумму @S с первого на второй счет, при это проверяя, достаточно ли средств на первом счете  
3. Использует транзакцию при переводе с первого на второй счет (показать, как работают транзакции).

Ответ:  
```sql
CREATE OR ALTER PROCEDURE TransferFunds
      @Id1 UNIQUEIDENTIFIER,         
      @Id2 UNIQUEIDENTIFIER,          
      @Money  decimal(19, 4)   
AS
BEGIN
    SET NOCOUNT ON;
    SET XACT_ABORT ON;  

    IF @Money <= 0
    BEGIN
        THROW 50001, 'Сумма перевода должна быть > 0.', 1;
    END;

    IF @Id1 = @Id2
    BEGIN
        THROW 50002, 'Нельзя переводить на тот же счёт.', 1;
    END;

    BEGIN TRY
        BEGIN TRAN;

        DECLARE 
            @BalSource decimal(19,4),
            @BalDest   decimal(19,4);

        IF @Id1 < @Id2
        BEGIN
            SELECT @BalSource = @Money 
            FROM dbo.Accounts WITH (UPDLOCK, HOLDLOCK, ROWLOCK)
            WHERE Id = @Id1;

            SELECT @BalDest = @Money
            FROM dbo.Accounts WITH (UPDLOCK, HOLDLOCK, ROWLOCK)
            WHERE Id = @Id2;
        END
        ELSE
        BEGIN
            SELECT @BalDest = @Money
            FROM Accounts WITH (UPDLOCK, HOLDLOCK, ROWLOCK)
            WHERE Id = @Id2;

            SELECT @BalSource = @Money 
            FROM Accounts WITH (UPDLOCK, HOLDLOCK, ROWLOCK)
            WHERE Id = @Id1;
        END

        IF @BalSource IS NULL
            THROW 50003, 'Исходный счёт не найден.', 1;

        IF @BalDest IS NULL
            THROW 50004, 'Счёт-получатель не найден.', 1;

        IF @BalSource < @Money
            THROW 50005, 'Недостаточно средств на исходном счёте.', 1;

        UPDATE Accounts
        SET Balance = Balance - @Money
        WHERE Id = @Id1;

        UPDATE Accounts
        SET Balance = Balance + @Money
        WHERE Id = @Id2;

        COMMIT TRAN;
    END TRY
    BEGIN CATCH
        IF XACT_STATE() <> 0
            ROLLBACK TRAN;

        THROW;
    END CATCH
END;
GO

```

2.2  ЗАДАЧА НА ВЫВОД В XML.  


Пусть есть таблица Purchase со следующим видом и содержанием. Что вернет SQL запрос?  
Id	Code	Name	StatusId  
1	SBR003-202001	Конкурс СМСП	45  
2	SBR003-202002	Запрос предложений	2  



SELECT Id, Code, Name, StatusId FROM Purchase FOR XML path('row'), ROOT('data')  

Ответ:  
```xml
<data>
  <row>
    <Id>1</Id>
    <Code>SBR003-202001</Code>
    <Name>Конкурс СМСП</Name>
    <StatusId>45</StatusId>
  </row>
  <row>
    <Id>2</Id>
    <Code>SBR003-202002</Code>
    <Name>Запрос предложений</Name>
    <StatusId>2</StatusId>
  </row>
</data>
```



2.3  

ЗАДАЧА НА ДИАГНОСТИКУ ПРОБЛЕМЫ.   


Есть автоматическое задание (task), которое выполняется каждую минуту. Таск регистрирует электронный документ «Результаты торгов». При регистрации документа возможно изменить атрибуты записи в БД. Таск также   определяется SQL запросом, который, собственно, и выбирает лоты, по которым надо сформировать этот документ. Вот пример этого SQL:  
```sql
SELECT Bid.Id, Purchase.OrgBuId, Purchase.TypeId  
FROM Bid JOIN Purchase ON Purchase.Id = Bid.PurchaseId  
WHERE Bid.StatusId = 6
```


Ситуация: вечером был перенос этого таска с тестового на боевой сервер. На следующий день вы приходите с утра и видите, что по всем подходящим лотам всю ночь каждую минуту формировался этот документ.   
Вопрос: почему так произошло и что надо исправить?  

Ответ:  
Документ формируется каждую минуту из-за того, что задача выполняется постоянно, а StatusId всегда равен 6.  
Как решить:  
Добавить поле Proccessed. Указывает, была ли обработана запись.  


3.1	Задача на валидность XML
Перед вами пример XML файла, но он не пройдет валидацию. Найдите все ошибки.
 <img width="710" height="553" alt="image" src="https://github.com/user-attachments/assets/33385073-ac4e-4d1f-b8c7-a3dd0841c83a" />  


 3.2	Поиск дублей в массиве
Дано:  
Есть массив M с типом int32, в массиве N элементов. N – очень много.  
Есть комп. с неограниченным объемом памяти. Память можно использовать любым образом.  
Вопрос:  
Циклом за один проход по массиву определить имеются ли в нем повторяющиеся элементы   
Написать алгоритм или рассказать идею, как решить  

```C#
bool HasDuplicate(int[] arr)
{
    int?[] support = new int?[Int32.MaxValue];

    for (int i = 0; i < arr.Length; i++)
    {
        if (support[i] == null)
            support[arr[i]] = arr[i];
        else
            return true;
    }

    return false;
}
```


4.1

Экономика:

Есть 2 формы налогообложения:  
Налог платится в размере 6% налогов от доходов  
Налог платится в размере 15% от разницы (доходы – расходы)  
Вопрос: при каком уровне расходов (в % от доходов) эти две системы эквивалентны по выплате налогов  

Ответ:  60%

4.3

Задачи на поиск и структурирование информации 


4.3.1	Как устроена система государственных закупок в Российской федерации?  

Ответ:  
Заказчик планирует закупку (включает в план-график).  
Публикует извещение о закупке в ЕИС.  
Поставщики подают заявки на ЭТП.  
Проводится аукцион или конкурс.  
Определяется победитель.  
Заключается контракт.  
Контролирующие органы (ФАС, казначейство) проверяют процесс.  


4.3.2	Что регулирует 44 ФЗ?  

Ответ:  
ФЗ №44 «О контрактной системе в сфере закупок товаров, работ, услуг для обеспечения государственных и муниципальных нужд» (от 05.04.2013) регулирует:  
Как государственные и муниципальные органы планируют закупки,  
Как они проводят аукционы, конкурсы, запросы котировок,  
Как заключаются, исполняются и контролируются гос- и муниципальные контракты,  
Как осуществляется контроль и ответственность за нарушения.  
44-ФЗ обязателен для всех госорганов, муниципалитетов и бюджетных учреждений.  


4.3.3	Что регулирует 223 ФЗ?  

Ответ:  
ФЗ №223 «О закупках товаров, работ, услуг отдельными видами юридических лиц» (от 18.07.2011) регулирует закупки компаний с госучастием:  
Государственные корпорации, госкорпорации, естественные монополии (Газпром, РЖД и др.).  
Процедуры закупок более гибкие, чем по 44-ФЗ (можно использовать свои положения о закупке).   
Не все закупки обязаны проводиться на ЭТП, но большинство — через ЕИС.  


4.3.4	Что такое «B to B»?  

Ответ:  

B2B (Business-to-Business) — это форма взаимодействия между двумя бизнесами, а не между бизнесом и конечным клиентом.  
Примеры B2B:  
Оптовые поставки (завод продаёт продукцию дистрибьютору).  
IT-компании, разрабатывающие корпоративные сервисы (например, CRM для других компаний).  
Торговые площадки типа Alibaba, где компании закупают партии товаров.  

